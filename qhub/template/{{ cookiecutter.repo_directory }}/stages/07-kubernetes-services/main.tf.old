
{% for helm_extension in cookiecutter.helm_extensions -%}
module "{{helm_extension['name'] }}-extension" {
  source       = "./modules/kubernetes/services/helm-extensions"
  name       = "{{ helm_extension['name'] }}"
  namespace  = var.environment
  repository = "{{ helm_extension['repository'] }}"
  chart      = "{{ helm_extension['chart'] }}"
  chart_version    = "{{ helm_extension['version'] }}"
  {% if 'overrides' in helm_extension -%}
  overrides = [<<EOT
{{ helm_extension['overrides']|yamlify -}}
    EOT
    ]
  {% endif -%}
  depends_on = [
    module.qhub
  ]
}

{% endfor -%}

{% if cookiecutter.prefect.enabled -%}
module "prefect" {
  source = "./modules/kubernetes/services/prefect"

  depends_on = [
    module.qhub
  ]
  namespace            = var.environment
  jupyterhub_api_token = module.qhub.jupyterhub_api_token
  prefect_token        = var.prefect_token
  {% if cookiecutter.prefect.image is defined -%}
  image                = "{{ cookiecutter.prefect.image }}"
  {% endif -%}
  {% if cookiecutter.prefect.overrides is defined %}
  overrides            = [<<EOT
{{ cookiecutter.prefect.overrides|yamlify -}}
    EOT
    ]
  {% endif %}
}
{% endif -%}


{% if cookiecutter.clearml.enabled -%}
module "clearml" {
  source       = "./modules/kubernetes/services/clearml"
  namespace    = var.environment
  external-url = var.endpoint
  tls          = module.qhub.tls
{% if cookiecutter.clearml.enable_forward_auth is defined -%}
  enable-forward-auth = {{ cookiecutter.clearml.enable_forward_auth | default(false,true) | jsonify }}
{% endif -%}
  depends_on = [
    module.qhub
  ]
}
{% endif -%}

resource "random_password" "forwardauth-jhsecret" {
  length  = 32
  special = false
}
